#!/usr/bin/env bash
set -euo pipefail

VERSION="0.1.0"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
BOLD='\033[1m'
NC='\033[0m'

log()  { echo -e "${GREEN}==> ${NC}$*"; }
warn() { echo -e "${YELLOW}==> ${NC}$*"; }
err()  { echo -e "${RED}==> ${NC}$*" >&2; }
info() { echo -e "${BLUE}==> ${NC}$*"; }

usage() {
  cat <<EOF
dev $VERSION — project launcher & worktree manager (powered by mise)

Usage: dev <command> [args]

Project Commands (delegated to mise tasks):
  up              Start services, install deps, setup DB, launch server
  down            Stop services
  setup           Install deps and setup DB without starting server

Worktree Commands:
  wt create NAME  Create a worktree with full setup
  wt remove NAME  Remove a worktree and its database
  wt list         List all worktrees and their status

Other:
  info            Show project info (mise config, tools, env)
  -h, --help      Show this help
  -v, --version   Show version

Configuration:
  Each project defines a mise.toml with [tools], [env], and [tasks].
  Worktree-specific overrides go in mise.local.toml (auto-generated).
EOF
}

# Find project root (git root or current dir)
find_project_root() {
  git rev-parse --show-toplevel 2>/dev/null || pwd
}

# Detect if we're inside a worktree
is_worktree() {
  local git_dir
  git_dir=$(git rev-parse --git-dir 2>/dev/null) || return 1
  [[ "$git_dir" == *"/worktrees/"* ]]
}

# Get worktree name from current directory
worktree_name() {
  basename "$(git rev-parse --show-toplevel 2>/dev/null)"
}

# Load project env vars from mise
load_mise_env() {
  eval "$(mise env 2>/dev/null)" || true
}

# Check if a PostgreSQL database exists
_db_exists() {
  local db="$1"
  local host="${DB_HOST:-localhost}"
  local port="${DB_PORT:-5432}"
  local user="${DB_USER:-postgres}"

  psql -U "$user" -h "$host" -p "$port" -tAc \
    "SELECT 1 FROM pg_database WHERE datname='$db'" 2>/dev/null | grep -q 1
}

# Create a database from a template
_db_create_from_template() {
  local new_db="$1"
  local template="$2"
  local host="${DB_HOST:-localhost}"
  local port="${DB_PORT:-5432}"
  local user="${DB_USER:-postgres}"

  psql -U "$user" -h "$host" -p "$port" -c \
    "CREATE DATABASE \"$new_db\" TEMPLATE \"$template\";" 2>/dev/null
}

# Drop a database
_db_drop() {
  local db="$1"
  local host="${DB_HOST:-localhost}"
  local port="${DB_PORT:-5432}"
  local user="${DB_USER:-postgres}"

  psql -U "$user" -h "$host" -p "$port" -c \
    "DROP DATABASE IF EXISTS \"$db\";" 2>/dev/null
}

# Apply worktree-specific overrides via mise.local.toml
# When inside a worktree, generates mise.local.toml with port offset and DB name
apply_worktree_context() {
  is_worktree || return 0

  local wt_name
  wt_name=$(worktree_name)

  load_mise_env

  local local_toml
  local_toml="$(git rev-parse --show-toplevel)/mise.local.toml"

  # Skip if mise.local.toml already exists with correct content
  if [[ -f "$local_toml" ]]; then
    return 0
  fi

  local content="# Auto-generated by dev for worktree: $wt_name\n[env]\n"

  # Calculate port offset
  if [[ -n "${PORT:-}" ]]; then
    local all_worktrees wt_index=0
    all_worktrees=$(git worktree list | awk '{print $1}' | sort)
    local current_root
    current_root=$(git rev-parse --show-toplevel)
    for wt in $all_worktrees; do
      if [[ "$wt" == "$current_root" ]]; then
        break
      fi
      wt_index=$((wt_index + 1))
    done
    if [[ $wt_index -gt 0 ]]; then
      local wt_port=$((PORT + wt_index))
      content+="PORT = \"$wt_port\"\n"
      info "Worktree port: $wt_port"
    fi
  fi

  # Set worktree-specific DB name
  if [[ -n "${DB_NAME:-}" ]]; then
    local wt_db="${DB_NAME}_${wt_name}"
    wt_db=$(echo "$wt_db" | sed 's/\//-/g')
    content+="DB_NAME = \"$wt_db\"\n"
    info "Worktree DB: $wt_db"
  fi

  echo -e "$content" > "$local_toml"
}

wt_create() {
  if [[ $# -eq 0 ]]; then
    err "Usage: dev wt create <name> [base-branch]"
    exit 1
  fi

  local name="$1"
  local base_branch="${2:-$(git symbolic-ref --short HEAD 2>/dev/null || echo main)}"
  local project_root
  project_root=$(find_project_root)

  load_mise_env

  local wt_dir="${project_root}/.worktrees"
  local wt_path="${wt_dir}/${name}"

  # Verify we're in a git repo
  if ! git rev-parse --git-dir >/dev/null 2>&1; then
    err "Not in a git repository"
    exit 1
  fi

  # Check if worktree already exists
  if [[ -d "$wt_path" ]]; then
    err "Worktree already exists: $wt_path"
    echo "  To enter it:  cd $wt_path"
    echo "  To remove it: dev wt remove $name"
    exit 1
  fi

  # Create worktrees directory and ensure it's gitignored
  mkdir -p "$wt_dir"
  if ! grep -q '\.worktrees' "$project_root/.gitignore" 2>/dev/null; then
    echo '.worktrees/' >> "$project_root/.gitignore"
    info "Added .worktrees/ to .gitignore"
  fi

  # Fetch latest
  log "Fetching latest..."
  git fetch origin --prune 2>/dev/null || true

  # Check if branch exists remotely or locally
  local remote_exists local_exists
  remote_exists=$(git branch -r --list "origin/$name" | grep -q . && echo "yes" || echo "no")
  local_exists=$(git branch --list "$name" | grep -q . && echo "yes" || echo "no")

  log "Creating worktree: $name"
  if [[ "$remote_exists" == "yes" ]]; then
    info "Found remote branch origin/$name"
    git worktree add "$wt_path" "$name" 2>/dev/null || \
      git worktree add "$wt_path" -b "$name" "origin/$name"
  elif [[ "$local_exists" == "yes" ]]; then
    info "Found local branch $name"
    git worktree add "$wt_path" "$name"
  else
    info "Creating new branch from $base_branch"
    git worktree add "$wt_path" -b "$name" "$base_branch"
  fi

  # Copy dependency directories for speed
  local copy_dirs="${WT_COPY_DIRS:-}"
  if [[ -n "$copy_dirs" ]]; then
    log "Copying dependencies from main worktree..."
    for dir in $copy_dirs; do
      if [[ -d "$project_root/$dir" ]] && [[ ! -d "$wt_path/$dir" ]]; then
        info "  Copying $dir..."
        cp -R "$project_root/$dir" "$wt_path/$dir"
      fi
    done
  fi

  # Symlink configured files from main worktree
  local symlink_files="${WT_SYMLINK_FILES:-}"
  if [[ -n "$symlink_files" ]]; then
    log "Symlinking files from main worktree..."
    for file in $symlink_files; do
      if [[ -f "$project_root/$file" ]] && [[ ! -f "$wt_path/$file" ]]; then
        mkdir -p "$(dirname "$wt_path/$file")"
        ln -s "$project_root/$file" "$wt_path/$file"
        info "  Symlinked $file"
      fi
    done
  fi

  # Enter worktree
  cd "$wt_path"

  # Install/update deps via mise
  log "Installing dependencies..."
  mise run deps 2>/dev/null || true

  # Create worktree-specific database
  local wt_db_name=""
  if [[ -n "${DB_NAME:-}" ]]; then
    wt_db_name="${DB_NAME}_${name}"
    wt_db_name=$(echo "$wt_db_name" | sed 's/\//-/g')

    log "Setting up database: $wt_db_name"

    # Start Docker if needed
    mise run docker:up 2>/dev/null || true

    # Try template clone first (fast), fall back to fresh create
    if _db_exists "$DB_NAME"; then
      info "Cloning from $DB_NAME template..."
      if _db_create_from_template "$wt_db_name" "$DB_NAME"; then
        log "Database cloned successfully"
      else
        warn "Template clone failed, will use mise setup..."
      fi
    fi
  fi

  # Generate mise.local.toml with worktree overrides
  local wt_port=""
  if [[ -n "${PORT:-}" ]]; then
    local wt_count
    wt_count=$(git worktree list | wc -l | tr -d ' ')
    wt_port=$((PORT + wt_count - 1))
  fi

  {
    echo "# Auto-generated by dev wt create"
    echo "[env]"
    if [[ -n "$wt_port" ]]; then
      echo "PORT = \"$wt_port\""
    fi
    if [[ -n "$wt_db_name" ]]; then
      echo "DB_NAME = \"$wt_db_name\""
    fi
  } > "$wt_path/mise.local.toml"

  # Print summary
  echo ""
  echo -e "${BOLD}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
  echo -e "${BOLD}Worktree ready: $name${NC}"
  echo -e "${BOLD}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
  echo ""
  echo "  Path: $wt_path"
  if [[ -n "$wt_port" ]]; then
    echo "  Port: $wt_port"
  fi
  if [[ -n "$wt_db_name" ]]; then
    echo "  DB:   $wt_db_name"
  fi
  echo ""
  echo "To start:"
  echo "  cd $wt_path && dev up"
  echo ""
  echo "To remove:"
  echo "  dev wt remove $name"
  echo ""
}

wt_remove() {
  if [[ $# -eq 0 ]]; then
    err "Usage: dev wt remove <name>"
    exit 1
  fi

  local name="$1"
  local project_root
  project_root=$(find_project_root)

  load_mise_env

  local wt_path="${project_root}/.worktrees/${name}"

  if [[ ! -d "$wt_path" ]]; then
    err "Worktree not found: $wt_path"
    echo ""
    echo "Available worktrees:"
    wt_list
    exit 1
  fi

  log "Removing worktree: $name"

  # Drop worktree database if configured
  if [[ -n "${DB_NAME:-}" ]]; then
    local wt_db_name="${DB_NAME}_${name}"
    wt_db_name=$(echo "$wt_db_name" | sed 's/\//-/g')

    # Start Docker if needed for DB operations
    mise run docker:up 2>/dev/null || true

    if _db_exists "$wt_db_name"; then
      info "Dropping database: $wt_db_name"
      _db_drop "$wt_db_name"
    fi

    # Also try dropping the test DB
    local wt_test_db="${DB_NAME/dev/test}_${name}"
    wt_test_db=$(echo "$wt_test_db" | sed 's/\//-/g')
    if _db_exists "$wt_test_db"; then
      info "Dropping test database: $wt_test_db"
      _db_drop "$wt_test_db"
    fi
  fi

  # Remove the git worktree
  log "Removing worktree directory..."
  git worktree remove "$wt_path" --force

  echo ""
  echo -e "${BOLD}Removed: $name${NC}"
}

wt_list() {
  local project_root
  project_root=$(find_project_root)

  load_mise_env

  echo ""
  echo -e "${BOLD}Worktrees for $(basename "$project_root"):${NC}"
  echo ""

  local worktrees
  worktrees=$(git worktree list 2>/dev/null)

  if [[ -z "$worktrees" ]]; then
    echo "  No worktrees found"
    return
  fi

  local port="${PORT:-}"
  local index=0
  while IFS= read -r line; do
    local path branch
    path=$(echo "$line" | awk '{print $1}')
    branch=$(echo "$line" | grep -oP '\[.*?\]' | tr -d '[]')
    local name
    name=$(basename "$path")

    local port_str=""
    if [[ -n "$port" ]]; then
      port_str=" | Port: $((port + index))"
    fi

    local db_info=""
    if [[ -n "${DB_NAME:-}" ]] && [[ $index -gt 0 ]]; then
      db_info=" | DB: ${DB_NAME}_${name}"
    elif [[ -n "${DB_NAME:-}" ]]; then
      db_info=" | DB: $DB_NAME"
    fi

    if [[ "$path" == "$project_root" ]]; then
      echo -e "  ${GREEN}*${NC} $name ($branch)${port_str}${db_info} ${GREEN}(main)${NC}"
    else
      echo "    $name ($branch)${port_str}${db_info}"
    fi
    index=$((index + 1))
  done <<< "$worktrees"

  echo ""
}

cmd_info() {
  echo ""
  echo -e "${BOLD}Project:${NC} $(basename "$(find_project_root)")"
  echo -e "${BOLD}Root:${NC}    $(find_project_root)"
  echo ""

  if is_worktree; then
    echo -e "${BOLD}Worktree:${NC} $(worktree_name)"
    echo ""
  fi

  echo -e "${BOLD}mise config:${NC}"
  mise ls 2>/dev/null || echo "  (no mise.toml found)"
  echo ""

  echo -e "${BOLD}Tasks:${NC}"
  mise tasks 2>/dev/null || echo "  (no tasks defined)"
  echo ""

  echo -e "${BOLD}Env (WT_* vars):${NC}"
  mise env 2>/dev/null | grep -E "^export WT_|^export DB_|^export PORT=" || echo "  (none)"
  echo ""
}

cmd_wt() {
  if [[ $# -eq 0 ]]; then
    err "Usage: dev wt <create|remove|list> [args]"
    exit 1
  fi

  case "$1" in
    create) shift; wt_create "$@" ;;
    remove) shift; wt_remove "$@" ;;
    list)   shift; wt_list "$@" ;;
    *)      err "Unknown worktree command: $1"; exit 1 ;;
  esac
}

main() {
  if [[ $# -eq 0 ]]; then
    usage
    exit 0
  fi

  case "$1" in
    up|down|setup)
      # Apply worktree context if needed, then delegate to mise
      apply_worktree_context
      exec mise run "$@"
      ;;
    info)     cmd_info ;;
    wt)       shift; cmd_wt "$@" ;;
    -h|--help)  usage ;;
    -v|--version) echo "dev $VERSION" ;;
    *)        err "Unknown command: $1"; usage; exit 1 ;;
  esac
}

main "$@"
